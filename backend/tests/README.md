# Tests Backend GestAsso - Suite Compl√®te

## üìã Vue d'ensemble

Cette suite de tests couvre l'int√©gralit√© des fonctionnalit√©s backend de l'API GestAsso selon les personas d√©finis dans le prompt :
- **Marc Dubois** : Gestionnaire de club
- **Julie Moreau** : Coach d'√©quipe
- **Emma Leblanc** : Athl√®te

## üèóÔ∏è Architecture des Tests

### Structure des Fichiers

```
tests/
‚îú‚îÄ‚îÄ ApiTestCase.php              # Classe de base pour tous les tests API
‚îú‚îÄ‚îÄ Functional/                  # Tests fonctionnels par feature
‚îÇ   ‚îú‚îÄ‚îÄ AuthenticationTest.php   # Tests d'authentification JWT
‚îÇ   ‚îú‚îÄ‚îÄ ClubManagementTest.php   # Tests gestion des clubs
‚îÇ   ‚îú‚îÄ‚îÄ FinancialTest.php        # Tests financiers et cagnottes
‚îÇ   ‚îú‚îÄ‚îÄ SecurityTest.php         # Tests s√©curit√© et permissions
‚îÇ   ‚îî‚îÄ‚îÄ DocumentTest.php         # Tests gestion des documents
‚îú‚îÄ‚îÄ Integration/                 # Tests d'int√©gration
‚îÇ   ‚îî‚îÄ‚îÄ UserJourneyTest.php      # Parcours utilisateurs complets
‚îú‚îÄ‚îÄ bootstrap.php                # Initialisation environnement de test
‚îî‚îÄ‚îÄ README.md                    # Cette documentation
```

## üß™ Types de Tests

### 1. Tests d'Authentification (`AuthenticationTest.php`)
- ‚úÖ Inscription utilisateur avec validation
- ‚úÖ Connexion JWT et r√©cup√©ration token
- ‚úÖ Refresh token et renouvellement
- ‚úÖ S√©curit√© des mots de passe (hashage)
- ‚úÖ Gestion des tokens expir√©s
- ‚úÖ Validation des credentials
- ‚úÖ Structure et contenu des tokens JWT

### 2. Tests de Gestion des Clubs (`ClubManagementTest.php`)
- ‚úÖ Cr√©ation de club avec propri√©taire
- ‚úÖ Gestion des saisons actives
- ‚úÖ Cr√©ation d'√©quipes avec prix et calendriers
- ‚úÖ **Restrictions d'√¢ge des √©quipes** : minBirthYear/maxBirthYear
- ‚úÖ **Validation d'√¢ge lors ajout membres** : Athl√®tes vs Coachs
- ‚úÖ Ajout de co-gestionnaires avec permissions
- ‚úÖ Assignation des coachs aux √©quipes
- ‚úÖ Isolation des donn√©es entre clubs
- ‚úÖ G√©n√©ration des √©ch√©anciers de paiement

### 3. Tests Financiers (`FinancialTest.php`)
- ‚úÖ **Calculs de cagnottes critiques** : √âv√©nement 2000‚Ç¨, 15% commission = 212.50‚Ç¨/participant
- ‚úÖ Attribution automatique aux cagnottes
- ‚úÖ Accumulation multi-√©v√©nements
- ‚úÖ R√®gles de d√©duction et commissions
- ‚úÖ Arrondi mon√©taire pr√©cis
- ‚úÖ Historique des transactions
- ‚úÖ Tableau de bord financier club
- ‚úÖ Retraits et validation des soldes

### 4. Tests de S√©curit√© (`SecurityTest.php`)
- ‚úÖ **Isolation des donn√©es par r√¥le** : Coach A ne voit pas √©quipes Coach B
- ‚úÖ Hi√©rarchie des permissions : Gestionnaire > Coach > Athl√®te
- ‚úÖ Tests n√©gatifs d'acc√®s (erreurs 403)
- ‚úÖ Protection contre l'injection SQL
- ‚úÖ Validation des entr√©es utilisateur
- ‚úÖ Pr√©vention de l'escalation de privil√®ges
- ‚úÖ Isolation cross-club

### 5. Tests de Documents (`DocumentTest.php`)
- ‚úÖ Upload s√©curis√© avec validation types/tailles
- ‚úÖ Workflow : Soumis ‚Üí En cours ‚Üí Valid√©/Refus√©
- ‚úÖ Notifications documents expir√©s
- ‚úÖ Permissions de validation par r√¥le
- ‚úÖ Organisation stockage par utilisateur/√©quipe
- ‚úÖ Versioning des documents
- ‚úÖ Statuts globaux d'√©quipe

### 6. Tests de Validation d'√Çge (`AgeValidationTest.php`)
- ‚úÖ **Gestion date de naissance utilisateurs** : Validation format et coh√©rence
- ‚úÖ **Restrictions d'√¢ge √©quipes** : minBirthYear/maxBirthYear par √©quipe
- ‚úÖ **Validation d'√¢ge athl√®tes** : Refus si trop jeune/√¢g√© pour √©quipe
- ‚úÖ **Exception coachs** : Coachs non soumis aux restrictions d'√¢ge
- ‚úÖ **√âquipes ouvertes** : √âquipes sans restriction acceptent tous √¢ges
- ‚úÖ **Messages d'erreur explicites** : "trop jeune", "trop √¢g√©", "date obligatoire"
- ‚úÖ **Calcul automatique tranche d'√¢ge** : Affichage "12-16 ans" depuis ann√©es naissance
- ‚úÖ **Validation coh√©rence** : minBirthYear ‚â§ maxBirthYear

### 7. Tests d'Int√©gration (`UserJourneyTest.php`)
- ‚úÖ **Parcours complet Marc Dubois** : Cr√©ation club ‚Üí √©quipes avec √¢ge ‚Üí √©v√©nements ‚Üí calculs
- ‚úÖ **Parcours complet Julie Moreau** : Assignation coach ‚Üí gestion √©quipe ‚Üí visualisation restrictions √¢ge
- ‚úÖ **Parcours complet Emma Leblanc** : Inscription avec √¢ge ‚Üí validation adh√©sion ‚Üí participation ‚Üí cagnotte
- ‚úÖ **Tests n√©gatifs int√©gr√©s** : Tentative ajout athl√®te trop jeune dans parcours

## ‚öôÔ∏è Configuration et Ex√©cution

### Pr√©requis
```bash
# Base de donn√©es PostgreSQL de test
createdb gestasso_test
createuser gestasso_test --password

# Cl√©s JWT de test
mkdir -p config/jwt
openssl genrsa -out config/jwt/private-test.pem -aes256 -passout pass:test 4096
openssl rsa -pubout -in config/jwt/private-test.pem -passin pass:test -out config/jwt/public-test.pem
```

### Variables d'Environnement Test
Cr√©er `.env.test` :
```env
APP_ENV=test
DATABASE_URL="postgresql://gestasso_test:password@localhost:5432/gestasso_test"
JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private-test.pem
JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public-test.pem
JWT_PASSPHRASE=test
```

### Commandes d'Ex√©cution

```bash
# Tous les tests
./vendor/bin/phpunit

# Tests par cat√©gorie
./vendor/bin/phpunit tests/Functional/AuthenticationTest.php
./vendor/bin/phpunit tests/Functional/FinancialTest.php
./vendor/bin/phpunit tests/Integration/UserJourneyTest.php

# Tests avec couverture
./vendor/bin/phpunit --coverage-html var/coverage

# Tests sp√©cifiques
./vendor/bin/phpunit --filter testCagnotteCalculationPrecision
./vendor/bin/phpunit --filter testCoachCannotAccessOtherTeam
```

## üéØ Cas de Tests Critiques Couverts

### Calculs Financiers (Priorit√© Haute)
```php
// Test √©v√©nement : 2000‚Ç¨ budget, 15% commission, 8 participants
// R√©sultat attendu : (2000 * 0.85) / 8 = 212.50‚Ç¨ par participant
$this->assertEquals(212.50, $responseData['individualGain']);
```

### Permissions et S√©curit√© (Priorit√© Haute)
```php
// Julie (coach) ne peut pas acc√©der √† l'√©quipe de Pierre
$this->authenticatedRequest('GET', '/api/teams/' . $otherTeam->getId(), $julie);
$this->assertErrorResponse(403, 'acc√®s refus√©');
```

### Validation d'√Çge (Priorit√© Haute)
```php
// √âquipe U18 : n√©s entre 2006 (18 ans max) et 2012 (12 ans min)
$teamData = [
    'name' => 'U18 Filles',
    'minBirthYear' => 2006, // 18 ans max en 2024
    'maxBirthYear' => 2012, // 12 ans min en 2024
];

// Athl√®te de 16 ans (n√©e en 2008) : ACCEPT√âE
$validAthlete = ['dateOfBirth' => '2008-05-20'];
$this->assertJsonResponse(201);

// Athl√®te de 9 ans (n√©e en 2015) : REFUS√âE
$tooYoungAthlete = ['dateOfBirth' => '2015-03-10'];
$this->assertErrorResponse(400, 'trop jeune');

// Coach de 35 ans : ACCEPT√â (exception pour coachs)
$oldCoach = ['dateOfBirth' => '1989-07-15', 'role' => 'coach'];
$this->assertJsonResponse(201);
```

### Workflow Documents (Priorit√© Moyenne)
```php
// Cycle complet : Upload ‚Üí Validation ‚Üí Resoumission
testDocumentValidationWorkflow()
testDocumentRejection()
testDocumentResubmission()
```

## üìä Couverture et M√©triques

### Objectifs de Couverture
- **Cible globale** : >85% couverture du code
- **Critique** : 100% sur calculs financiers et s√©curit√©
- **Entit√©s** : 100% sur User, Club, Team, Event, Cagnotte

### M√©triques de Performance
- **Temps r√©ponse** : <200ms pour endpoints simples
- **Tests d'isolation** : Rollback automatique des transactions
- **M√©moire** : <128MB par processus test

## üîß Donn√©es de Test (Fixtures)

### Utilisateurs de Base
```php
$marcDubois = $this->createTestUser(
    'marc.dubois@racingclub.com',
    ['ROLE_CLUB_OWNER'],
    ['firstName' => 'Marc', 'lastName' => 'Dubois']
);
```

### Sc√©narios Financiers
```php
// Cas de test avec diff√©rents budgets et commissions
$testCases = [
    ['budget' => 2000.00, 'commission' => 15.0, 'participants' => 8, 'expected' => 212.50],
    ['budget' => 1500.00, 'commission' => 10.0, 'participants' => 6, 'expected' => 225.00],
];
```

## üöÄ Ex√©cution Continue (CI/CD)

### Pipeline Recommand√©
```yaml
# .github/workflows/tests.yml
- name: Run Tests
  run: |
    php bin/console doctrine:database:create --env=test
    php bin/console doctrine:schema:create --env=test
    ./vendor/bin/phpunit --coverage-clover coverage.xml
    
- name: Security Scan
  run: ./vendor/bin/phpunit tests/Functional/SecurityTest.php
```

## üìù Cas d'Usage Valid√©s

### ‚úÖ Persona Marc Dubois - Gestionnaire
- Cr√©ation Racing Club Paris avec √©quipes Seniors (450‚Ç¨, 18+ ans) et U18 Filles (320‚Ç¨, 12-18 ans)
- **Configuration restrictions d'√¢ge** : Seniors (maxBirthYear: 2006), U18 (minBirthYear: 2006, maxBirthYear: 2012)
- Configuration √©ch√©anciers 3 paiements (106.67‚Ç¨ chacun)
- Cr√©ation √©v√©nement "Tournoi National U18" (2000‚Ç¨, 15% commission)
- **Validation d'√¢ge automatique** lors ajout membres aux √©quipes
- Ajout Sophie Martin comme co-gestionnaire
- Configuration documents obligatoires

### ‚úÖ Persona Julie Moreau - Coach
- Assignation √©quipe U18 Filles par Marc (possible malgr√© √¢ge 32 ans)
- **Visualisation restrictions d'√¢ge √©quipe** : 12-18 ans (2006-2012)
- Consultation tableau de bord financier √©quipe
- Acc√®s restreint aux donn√©es de son √©quipe uniquement
- Impossibilit√© de cr√©er √©v√©nements ou modifier prix
- Envoi rappels de paiement personnalis√©s

### ‚úÖ Persona Emma Leblanc - Athl√®te
- **Inscription avec date de naissance** : 15/03/2008 (16 ans)
- **Validation automatique d'√¢ge** : √âligible pour √©quipe U18 (12-18 ans)
- Ajout √©quipe U18 Filles avec succ√®s (√¢ge valide)
- Upload certificat m√©dical et licence FFT
- Suivi √©ch√©ances paiement (3 x 106.67‚Ç¨)
- Participation tournoi ‚Üí Attribution cagnotte 212.50‚Ç¨
- Consultation historique et retrait 100‚Ç¨
- Interface lecture seule pour donn√©es financi√®res

### ‚úÖ Cas d'Erreur d'√Çge Valid√©s
- **Athl√®te trop jeune** : Refus athl√®te 9 ans pour √©quipe U18 (message "trop jeune")
- **Athl√®te trop √¢g√©** : Refus athl√®te 25 ans pour √©quipe U18 (message "trop √¢g√©")
- **Date manquante** : Refus si pas de date de naissance pour √©quipe avec restrictions
- **√âquipe incoh√©rente** : Erreur si minBirthYear > maxBirthYear
- **Coach exception** : Coach 35 ans accept√© sur √©quipe U18 (r√¥le non soumis aux restrictions)

## üéâ R√©sultats Attendus

Cette suite de tests valide l'int√©gralit√© des fonctionnalit√©s critiques de l'API GestAsso avec :
- **Couverture exhaustive** des cas d'erreur et de succ√®s
- **Isolation parfaite** des donn√©es entre utilisateurs/clubs
- **Calculs financiers pr√©cis** au centime pr√®s
- **S√©curit√© robuste** contre les attaques communes
- **Workflow complet** de gestion documentaire

**Status** : ‚úÖ Pr√™t pour validation et d√©ploiement 